<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sora Prompt Playground</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-25DRZ2VJN4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-25DRZ2VJN4");
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='46' fill='%236348ff'/><text x='50' y='58' font-size='44' text-anchor='middle' fill='white' font-family='Arial, sans-serif'>S</text></svg>" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="hero">
      <nav class="nav">
        <div class="logo">Sora Prompt Playground</div>
        <button class="nav-toggle" aria-label="Toggle navigation">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="nav-links">
          <a href="#generator">Playground</a>
          <a href="#about">About</a>
          <a href="#features">Features</a>
          <a href="#workflow">Workflow</a>
          <a href="#stories">Creator Stories</a>
        </div>
        <a class="cta-link" href="#signup">Join Beta</a>
      </nav>
      <div class="hero-body">
        <div class="hero-generator" id="generator">
          <div class="generator-intro">
            <span class="bubble-tag">AI Prompt Bubble Machine</span>
            <h1>Start the conversation and watch a Sora prompt appear</h1>
            <p>
              Tell the bubble machine about your main character, the setting, and a signature line.
              It will spin them into a cinematic prompt ready for Sora, complete with camera moves and mood cues.
            </p>
          </div>
          <div class="generator">
            <form id="promptForm" class="generator-form">
              <label>
                Character
                <input
                  type="text"
                  name="character"
                  placeholder="Example: Bubble-wielding street magician"
                  required
                />
              </label>
              <label>
                Setting
                <input
                  type="text"
                  name="setting"
                  placeholder="Example: A neon night market stage with levitating spectators"
                  required
                />
              </label>
              <label>
                Line / Plot Beat
                <textarea
                  name="dialogue"
                  placeholder="Example: Hold tight—these bubbles are portals to impossible worlds!"
                  rows="3"
                  required
                ></textarea>
              </label>
              <label>
                Duration (seconds)
                <input
                  type="number"
                  name="duration"
                  placeholder="Example: 10"
                  min="1"
                  max="15"
                  value="10"
                  required
                />
              </label>
              <div class="form-actions">
                <button type="submit" class="btn primary">Shake the Bubble</button>
                <button type="button" class="btn ghost" id="shuffleIdea">
                  Need Inspiration
                </button>
              </div>
            </form>
            <div class="generator-output">
              <div class="output-header">
                <h3>Generated Sora Prompt</h3>
                <button class="btn tiny" id="copyPrompt">Copy</button>
              </div>
              <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Generating... 0%</div>
              </div>
              <textarea id="promptResult" class="prompt-result" rows="8">Tap "Shake the Bubble" to get a complete Sora prompt with camera, lighting, and sound directions.</textarea>
              <div class="prompt-tags" id="promptTags"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="hero-wave" aria-hidden="true"></div>
    </header>

    <script>
      const promptForm = document.getElementById("promptForm");
      const shuffleBtn = document.getElementById("shuffleIdea");
      const promptResult = document.getElementById("promptResult");
      const promptTags = document.getElementById("promptTags");
      const copyBtn = document.getElementById("copyPrompt");
      const navToggle = document.querySelector(".nav-toggle");
      const progressContainer = document.getElementById("progressContainer");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const navLinks = document.querySelector(".nav-links");
      const bubbleTrail = document.querySelector(".bubble-trail");
      const generateBtn = promptForm.querySelector('button[type="submit"]');

      const ideaPresets = [
        {
          character: "Dream-diving detective cat",
          setting: "A city made of soft candy skyscrapers with giant ticking pocket watches in the sky",
          dialogue: "Every clue is sugar-coated—catch it before the nightmare does!",
        },
        {
          character: "Bubble-wielding street magician",
          setting: "A neon night market stage surrounded by levitating spectators trapped in shimmering bubbles",
          dialogue: "Hold tight—these bubbles are portals to impossible worlds!",
        },
        {
          character: "Time-hopping paper airplane courier",
          setting: "A hand-drawn tunnel of eras where postcards from every century drift overhead",
          dialogue: "Next delivery: future you—keep this note of courage safe.",
        },
      ];

      const lensOptions = [
        "Fisheye ultra-wide shot with exaggerated perspective",
        "Gentle push-in inspired by animated storyboards",
        "Hand-drawn handheld feel with playful sways",
        "Low-angle hero frame amplifying the character’s presence",
        "Floating drone orbit that sells the weightless world",
      ];

      const lightOptions = [
        "Candy-neon key lights with softened halos",
        "Warm amber and lavender rim lights for dreamlike contrast",
        "Volumetric beams that slice through floating particles",
        "Diffused daylight from the side with fairy-tale bloom",
        "Alternating cool and warm spotlights like a stage show",
      ];

      const musicOptions = [
        "Score: upbeat electro-jazz with playful xylophone riffs",
        "Score: retro synthwave beats layered with children’s choir hums",
        "Score: airy melodica and hand drums plus bubble pop foley",
        "Score: orchestral swell punctuated by glittering star chimes",
        "Score: futuristic chiptune tempo with hula-hoop whooshes",
      ];

      const tagOptions = [
        "#CartoonStyle",
        "#NeonDream",
        "#CinematicCamera",
        "#BubbleFX",
        "#FairyTaleMood",
        "#SlowMotion",
        "#MusicCues",
        "#VariantReady",
      ];

      function randomPick(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      async function requestPromptFromServer(values) {
        const response = await fetch("/api/prompts/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(values),
        });

        if (!response.ok) {
          const errorBody = await response.json().catch(() => ({}));
          const message = errorBody?.error || `Request failed with status ${response.status}`;
          throw new Error(message);
        }

        const data = await response.json();
        if (!data?.prompt) {
          throw new Error("Prompt missing in response.");
        }

        return data.prompt.trim();
      }

      function buildFallbackPrompt(values) {
        const { character, setting, dialogue, duration } = values;
        const lens = randomPick(lensOptions);
        const light = randomPick(lightOptions);
        const music = randomPick(musicOptions);
        const variant = ["A", "B", "C"][Math.floor(Math.random() * 3)];

        return `Sora Prompt Variant ${variant}:
Lead Character: ${character}. Setting: ${setting}. Camera Language: ${lens}, keeping animation-like ease and showcasing micro expressions.
Atmosphere: ${light}, with particles drifting to the rhythm and shadows softened for charm. Palette: pastel blues, peach glow, and sparkly yellow highlights.
Action: The hero completes the task with a delightful twist—add exaggerated reactions and 2D speed lines for impact.
Signature Line: ${dialogue}
Audio: ${music}, plus bubble pops and star sparkle Foley timed with key movements.
Duration: ${duration} seconds with pacing optimized for the action.
Delivery: 24fps, 16:9, illustrated animation texture, gentle depth-of-field glow.`;
      }

      function updateTags() {
        const picks = new Set();
        while (picks.size < 4) {
          picks.add(randomPick(tagOptions));
        }
        promptTags.innerHTML = "";
        picks.forEach((tag) => {
          const span = document.createElement("span");
          span.textContent = tag;
          promptTags.appendChild(span);
        });
      }

      function showBubbleBurst() {
        bubbleTrail.classList.add("active");
        setTimeout(() => bubbleTrail.classList.remove("active"), 1200);
      }

      function updateProgress(percent, text) {
        progressFill.style.width = percent + "%";
        progressText.textContent = text || `Generating... ${percent}%`;
      }

      function showProgress() {
        progressContainer.style.display = "block";
        updateProgress(0, "Initializing...");
      }

      function hideProgress() {
        progressContainer.style.display = "none";
        updateProgress(0, "");
      }

      function simulateProgress(duration = 5000) {
        return new Promise((resolve) => {
          const steps = [
            { percent: 20, text: "Analyzing creative brief...", delay: 500 },
            { percent: 40, text: "Crafting camera angles...", delay: 1000 },
            { percent: 60, text: "Designing lighting & mood...", delay: 1500 },
            { percent: 80, text: "Adding audio cues...", delay: 2000 },
            { percent: 95, text: "Finalizing prompt...", delay: 2500 },
          ];

          steps.forEach((step) => {
            setTimeout(() => {
              updateProgress(step.percent, step.text);
            }, step.delay);
          });

          setTimeout(() => {
            updateProgress(100, "Complete!");
            setTimeout(resolve, 300);
          }, duration);
        });
      }

      function setLoadingState(isLoading) {
        if (isLoading) {
          generateBtn.disabled = true;
          shuffleBtn.disabled = true;
          promptResult.classList.add("loading");
          promptResult.value = "Bubble machine is stitching your Sora prompt...";
          showProgress();
        } else {
          generateBtn.disabled = false;
          shuffleBtn.disabled = false;
          promptResult.classList.remove("loading");
          hideProgress();
        }
      }

      promptForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(promptForm);
        const values = {
          character: formData.get("character").trim(),
          setting: formData.get("setting").trim(),
          dialogue: formData.get("dialogue").trim(),
          duration: formData.get("duration"),
        };

        if (!values.character || !values.setting || !values.dialogue || !values.duration) {
          promptResult.value = "Fill in the character, setting, and line so the bubbles know what to build.";
          return;
        }

        try {
          setLoadingState(true);
          
          // Start progress simulation and API request in parallel
          const [generatedPrompt] = await Promise.all([
            requestPromptFromServer(values),
            simulateProgress(5000)
          ]);
          
          promptResult.value = generatedPrompt;
          updateTags();
          showBubbleBurst();
        } catch (error) {
          console.error("Prompt generation failed:", error);
          const fallback = buildFallbackPrompt(values);
          promptResult.value = `We couldn't reach the LLM right now, so here's a playful fallback you can tweak:\n\n${fallback}`;
          updateTags();
        } finally {
          setLoadingState(false);
        }
      });

      shuffleBtn.addEventListener("click", () => {
        const preset = randomPick(ideaPresets);
        promptForm.elements.character.value = preset.character;
        promptForm.elements.setting.value = preset.setting;
        promptForm.elements.dialogue.value = preset.dialogue;
        promptResult.value = "Inspiration loaded! Hit “Shake the Bubble” to see what the machine invents.";
      });

      copyBtn.addEventListener("click", async () => {
        const text = promptResult.value.trim();
        if (
          !text ||
          text.startsWith("Tap “Shake") ||
          text.startsWith("Fill in the character")
        ) {
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          copyBtn.textContent = "Copied!";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1600);
        } catch (err) {
          copyBtn.textContent = "Copy failed";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1600);
        }
      });

      navToggle.addEventListener("click", () => {
        navToggle.classList.toggle("open");
        navLinks.classList.toggle("open");
      });
    </script>
  </body>
</html>
